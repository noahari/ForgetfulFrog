<!DOCTYPE html>

<html>

  <head>

    <title>Forgetful Frog</title>

    <meta name = "viewport" content = "width=device-width, initial-scale=1.0">
    <script src="lib/jspsych-6.0.5/jspsych.js"></script>
    <script src="lib/jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
    <!--<link href="../jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>-->
    <link href = "tiling.css" rel = "stylesheet" type = "text/css">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  </head>

  <body>
    
    <script src = "procgen.js" type = "text/javascript"></script>
    <script src="memory-map.js"></script>
    <div id="buttonbar">
      <button id='bgmhideaway' onclick="startBGM"></button>
      <img id="fullscreenh" src='img/exitfullscreen.png'>
      <img id="sound" src='img/volumeon.svg' onclick="toggleSounds()">
      <img id="music" src='img/musicon.png' onclick="toggleBGM()">
      <img id="profile" src='img/levelCircle.png'>
      <audio id='hop' src='audio/hop.wav'></audio>
      <audio id='ding' src='audio/ding.wav'></audio>
      <audio id='splash' src='audio/splash.wav'></audio>
      <audio id='bgm' src='audio/bga2.wav' autoplay loop></audio>
    </div>
    <div id="tutorial">
      <div id='tutbox'>
        <p id='tuttxt'>Hop to the fly using either the arrow keys or the arrows in the bottom right-hand corner!</p>
      </div>
    </div>
    <div id='circlewrap'><img id='levelCircle' src='img/levelCircleF.png'><div id='lvltxtC'>Level<br>6</div></div>
    <div id="game"></div>
  
  </body>
  <script>
    var timeline = [];
    var lives = 10000;
    //init to -n where n is # of tutorial stages
    var spiketrack = -2;
    var consecutives = 0;
    var fails = 0;
    var timemax = 3.5;
    var timemin = 2.5;
    var tutover = false;
    var score = 0;
    var goal = 500;
    var silenced = false;

    var bgm = null;//new Audio("audio/bga2.wav");
    //bgm.id = 'bgm';
    //bgm.load();

    startBGM = function(){
      if(!silenced){
        bgm.play();
      }
    }

    toggleBGM = function(){
      if(!bgm.paused){
        bgm.pause();
        silenced = true;
      }
      else{
        bgm.currentTime = 0;
        bgm.play();
        silenced = false;
      }
    }

    var hop = null;
    var ding = null;
    var splash = null;
    
    initSounds = function(){/*
      hop = document.createElement("AUDIO");
      hop.src = "audio/hop.wav";
      ding = document.createElement("AUDIO");
      ding.src = "audio/ding.wav";
      splash = document.createElement("AUDIO");
      splash.src = "audio/splash.wav"*/
      hop = document.getElementById("hop");
      ding = document.getElementById("ding");
      splash = document.getElementById("splash");
      bgm = document.getElementById("bgm"); 
      bgm.volume = 0.7;
      if(bgm.paused && !silenced){
        bgm.play();
      }
    }

    toggleSounds = function(){
      if(hop == null || splash == null || ding == null || bgm == null){
        initSounds();
      }
      if(hop.volume == 1.0){
        hop.volume = 0.0;
      }
      else{
        hop.volume = 1.0;
      }
      if(ding.volume == 1.0){
        ding.volume = 0.0;       
      }
      else{
        ding.volume = 1.0;
      }
      if(splash.volume == 1.0){
        splash.volume = 0.0;       
      }
      else{
        splash.volume = 1.0;
      }
      if(!bgm.paused){
        bgm.pause();
        silenced = true;
      }
      else{
        bgm.currentTime = 0;
        bgm.play();
        silenced = false;
      }
    }

    var trial = {
      type: "memory-map",
      exit_length: 4,
      lives: function(){return lives;},
      wins: function(){return spiketrack-1;},
      score: function(){return score;},
      blackout_speed: function(){
        return ((Math.random() * (timemax - timemin))+timemin)*1000;
      },
      on_start: function(){
        tutover = true;
      }
    };
    var tut1 = {
      type: "memory-map",
      game_map: [1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,0,2,1,1,1,1,
                 1,1,1,0,1,1,1,1,1,
                 1,1,1,0,0,1,1,1,1,
                 1,1,1,1,0,1,1,1,1,
                 1,1,1,1,-1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,],
      tutorial: true,
      row_length: 9,
      column_height: 9,
      lives: function(){return lives;},
      wins: function(){return spiketrack},
      on_finish: function(){
        var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: false}).count();
        if(ts == 1){
          jsPsych.addNodeToEndOfTimeline(tut1, function(){});
        }
        else{
          document.getElementById("tuttxt").innerHTML = "The lilypads will disappear after you hop or wait too long, remember the path!"
          jsPsych.addNodeToEndOfTimeline(tut2, function(){});
        }
      }
    };
    var tut2 = {
      type: "memory-map",
      game_map: [1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,1,0,0,2,1,1,
                 1,1,1,1,0,1,1,1,1,
                 1,1,1,1,-1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,],
      tutorial: false,
      lives: function(){return lives;},
      wins: function(){return spiketrack},
      on_finish: function(){
        var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: false}).count();
        if(ts == 1){
          jsPsych.addNodeToEndOfTimeline(tut2, function(){});
        }
        else{
          fails = 0;
          spiketrack = 0;
          jsPsych.addNodeToEndOfTimeline(trial, function(){});
        }
      }
    };
    function failcheck(){
      var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: false}).count();
      if((ts == 1)&&tutover){
        lives--;
        fails++;
        consecutives = 0;
        if(fails >= 3){
          timemax = 3.5;
          timemin = 2.5;
          spiketrack = 0;
          if(trial.exit_length>1){
            trial.exit_length = trial.exit_length - 1;
            document.getElementById("lvltxtC").innerHTML = "Level<br>"+trial.exit_length;
            document.getElementById("lvltxtC").style.color = "red";
            document.getElementById('circlewrap').style.opacity = 0;
            window.requestAnimationFrame(fadeInCircle);
          }
          fails = 0;
        }
        if(score>0){
          score = score-(fails*5+5);
        }
        if(score<0){
          score = 0;
        }
      }
    }

    function spikecheck(){
      var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: true}).count();
      if((ts == 1)&&(spiketrack>=0)&&tutover){
        timemax = timemax - .5;
        timemin = timemin - .5;
        spiketrack++;
        consecutives++;
        if(consecutives >= 0){
          if(consecutives == 0){
            score = score+5;
          }
          else{
            score = score+(consecutives*5+5);
          }
        }
      }
      if(spiketrack >= 5){
        spiketrack = 0;
        fails = 0;
        trial.exit_length = trial.exit_length + 1;
        //must be set .5 higher since .5 subtracted after
        timemax = 3.5;
        timemin = 2.5;
        document.getElementById("lvltxtC").innerHTML = "Level<br>"+trial.exit_length;
        document.getElementById("lvltxtC").style.color = "green";
        document.getElementById('circlewrap').style.opacity = 0;
        window.requestAnimationFrame(fadeInCircle);
      }
    }

    var faded = false;
    fadeInCircle = function(){
      var cw = document.getElementById('circlewrap');
      cw.style.opacity = parseFloat(cw.style.opacity) + .04;
      if(cw.style.opacity < 1){
        window.requestAnimationFrame(fadeInCircle);
      }
      else{
        window.requestAnimationFrame(fadeOutCircle);
      }
    }
    fadeOutCircle = function(){
      var cw = document.getElementById('circlewrap');
      cw.style.opacity = parseFloat(cw.style.opacity) - .04;
      if(cw.style.opacity > 0){
        window.requestAnimationFrame(fadeOutCircle);
      }
    }

    var start = null;
    delay = function(int,func){
      if(start == null){
        start = Date.now();
      }
      var progress = Date.now() - start;
      if(progress < int){
        //anon func t prevent glob
        id = requestAnimationFrame(function(timestamp){
          delay(int,func);
        });
        RAFid.push(id);
      }
      else{
        start = null;
        func();
        return;
      }
    }

    function postMap(){
      failcheck();
      spikecheck();
      if((score < goal)&&(tutover)){
        jsPsych.addNodeToEndOfTimeline(trial, function(){});
      }
      else{
        if(tutover){
          //Allow continue?
        }
      }
    }

    timeline.push(tut1);
    //begin
  jsPsych.init({
  timeline: timeline,
  display_element: 'game',
      on_trial_finish: function(){
        postMap();
      },
      on_finish: function(){
        jsPsych.data.displayData();
        }
});

  </script>

</html>