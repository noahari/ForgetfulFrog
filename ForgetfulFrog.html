<!DOCTYPE html>

<html>

  <head>

    <title>Forgetful Frog</title>

    <meta name = "viewport" content = "width=device-width, initial-scale=1.0">
    <script src="lib/jspsych-6.0.5/jspsych.js"></script>
    <script src="lib/jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
    <!--<link href="../jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>-->
    <link href = "tiling.css" rel = "stylesheet" type = "text/css">

  </head>

  <body>
    
    <script src = "procgen.js" type = "text/javascript"></script>
    <script src="memory-map.js"></script>
  
  </body>
  <script>
    //https://stackoverflow.com/questions/48234696/how-to-put-a-gif-with-canvas/48297226
    var timeline = [];
    var lives = 10000;
    //init to -n where n is # of tutorial stages
    var consecutives = -1;
    var timemax = 3.5;
    var timemin = 2.5;
    var tutover = false;
    var trial = {
      type: "memory-map",
      exit_length: 4,
      lives: function(){return lives;},
      wins: function(){return consecutives-1},
      blackout_speed: function(){
        return ((Math.random() * (timemax - timemin))+timemin)*1000;
      },
      on_start: function(){
        tutover = true;
      }
    };
    var tut1 = {
      type: "memory-map",
      game_map: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,0,0,2,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,-1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,],
      tutorial: true,
      column_height: 16,
      lives: function(){return lives;},
      wins: function(){return consecutives},
      on_finish: function(){
        var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: false}).count();
        if(ts == 1){
          jsPsych.addNodeToEndOfTimeline(tut1, function(){});
        }
        else{
          //jsPsych.addNodeToEndOfTimeline(tut2, function(){});
          consecutives = 0;
          jsPsych.addNodeToEndOfTimeline(trial, function(){});
        }
      }
    };
    var tut2 = {
      type: "memory-map",
      game_map: [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,0,0,0,0,2,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,-1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,],
      tutorial: false,
      lives: function(){return lives;},
      wins: function(){return consecutives},
      on_finish: function(){
        tutover = true;
        consecutives = 0;
      }
    };
    function failcheck(){
      var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: false}).count();
      if(ts == 1){
        lives--;
        //console.log("loss detected, lives: "+lives);
      }
    }
    function spikecheck(){
      var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: true}).count();
      if((ts == 1)&&(consecutives>=0)&&tutover){
        console.log("win detected");
        timemax = timemax - .5;
        timemin = timemin - .5;
        //CHANGE TIME VAR
        //jsPsych.addNodeToEndOfTimeline(trial, function(){});
        //console.log("NODE ADDED");
        consecutives++;
      }
      if(consecutives >= 5){
        consecutives = 0;
        trial.exit_length = trial.exit_length + 1;
        //must be set .5 higher since .5 subtracted after
        timemax = 3.5;
        timemin = 2.5;
      }
    }
    function postMap(){
      //console.log("consec: "+consecutives);
      failcheck();
      spikecheck();
      if((lives > 0)&&(tutover)){
        jsPsych.addNodeToEndOfTimeline(trial, function(){});
        console.log("TIME RANGE: "+timemin+" - "+timemax);
      }
    }
    var instructions = {
      type: "html-button-response",
      stimulus: "<p>You are a frog hopping across some lilypads! " +
      "Unfortunately for you, you are so hungry for flies you forgot where the lilypads are. " +
      "</div>",
      choices: ["Start"],
      button_html: '<button class="jspsych-btn">%choice%</button>'
    };
    timeline.push(instructions);
    timeline.push(tut1);
    //timeline.push(trial);
    //begin
  jsPsych.init({
  timeline: timeline,
      on_trial_finish: function(){
        postMap();
      },
      on_finish: function(){
        jsPsych.data.displayData();
        }
});

  </script>

</html>