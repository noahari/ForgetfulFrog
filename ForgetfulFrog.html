<!DOCTYPE html>

<html>

  <head>

    <title>Forgetful Frog</title>

    <meta name = "viewport" content = "width=device-width, initial-scale=1.0">
    <script src="lib/jspsych-6.0.5/jspsych.js"></script>
    <script src="lib/jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
    <!--<link href="../jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>-->
    <link href = "tiling.css" rel = "stylesheet" type = "text/css">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  </head>

  <body>
    
    <script src = "procgen.js" type = "text/javascript"></script>
    <script src="memory-map.js"></script>
    <div id="buttonbar">
      <button id='bgmhideaway' onclick="startBGM"></button>
      <img id="fullscreenh" src='img/exitfullscreen.png'>
      <img id="sound" src='img/volumeon.svg'>
      <img id="music" src='img/musicon.png' onclick="toggleBGM()">
      <img id="profile">
    </div>
    <div id="tutorial">
      <div id='tutbox'>
        <p id='tuttxt'>Hop to the fly using either the arrow keys or the arrows in the bottom right-hand corner!</p>
      </div>
    </div>
    <div id="game"></div>
  
  </body>
  <script>
    var timeline = [];
    var lives = 10000;
    //init to -n where n is # of tutorial stages
    var consecutives = -2;
    var fails = 0;
    var timemax = 3.5;
    var timemin = 2.5;
    var tutover = false;
    var score = 0;
    var goal = 500;

    var bgm = new Audio("audio/bga2.wav");
    bgm.id = 'bgm';
    bgm.autoplay = true;
    bgm.loop = true;
    bgm.volume = 0.7;
    bgm.load();

    startBGM = function(){
      bgm.play();
    }

    toggleBGM = function(){
      if(!bgm.paused){
        bgm.pause();
      }
      else{
        bgm.currentTime = 0;
        bgm.play();
      }
    }

    var trial = {
      type: "memory-map",
      exit_length: 4,
      lives: function(){return lives;},
      wins: function(){return consecutives-1;},
      score: function(){return score;},
      blackout_speed: function(){
        return ((Math.random() * (timemax - timemin))+timemin)*1000;
      },
      on_start: function(){
        tutover = true;
      }
    };
    var tut1 = {
      type: "memory-map",
      game_map: [1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,0,2,1,1,1,1,
                 1,1,1,0,1,1,1,1,1,
                 1,1,1,0,0,1,1,1,1,
                 1,1,1,1,0,1,1,1,1,
                 1,1,1,1,-1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,],
      tutorial: true,
      row_length: 9,
      column_height: 9,
      lives: function(){return lives;},
      wins: function(){return consecutives},
      on_finish: function(){
        var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: false}).count();
        if(ts == 1){
          jsPsych.addNodeToEndOfTimeline(tut1, function(){});
        }
        else{
          document.getElementById("tuttxt").innerHTML = "The lilypads will disappear after you hop or wait too long, remember the path!"
          jsPsych.addNodeToEndOfTimeline(tut2, function(){});
        }
      }
    };
    var tut2 = {
      type: "memory-map",
      game_map: [1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,1,0,0,2,1,1,
                 1,1,1,1,0,1,1,1,1,
                 1,1,1,1,-1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,
                 1,1,1,1,1,1,1,1,1,],
      tutorial: false,
      lives: function(){return lives;},
      wins: function(){return consecutives},
      on_finish: function(){
        var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: false}).count();
        if(ts == 1){
          jsPsych.addNodeToEndOfTimeline(tut2, function(){});
        }
        else{
          fails = 0;
          consecutives = 0;
          jsPsych.addNodeToEndOfTimeline(trial, function(){});
        }
      }
    };
    function failcheck(){
      var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: false}).count();
      if((ts == 1)&&tutover){
        lives--;
        fails++;
        if(fails >= 3){
          timemax = 3.5;
          timemin = 2.5;
          consecutives = 0;
          if(trial.exit_length>1){
            trial.exit_length = trial.exit_length - 1;
          }
          fails = 0;
        }
        score = score-(fails*5+5);
      }
    }
    function spikecheck(){
      var ts = jsPsych.data.get().last(1).filter({trial_type: 'memory-map'}).filter({success: true}).count();
      if((ts == 1)&&(consecutives>=0)&&tutover){
        timemax = timemax - .5;
        timemin = timemin - .5;
        consecutives++;
        score = score+(consecutives*5+5);
      }
      if(consecutives >= 5){
        consecutives = 0;
        fails = 0;
        trial.exit_length = trial.exit_length + 1;
        //must be set .5 higher since .5 subtracted after
        timemax = 3.5;
        timemin = 2.5;
      }
    }
    function postMap(){
      failcheck();
      spikecheck();
      if((score < goal)&&(tutover)){
        jsPsych.addNodeToEndOfTimeline(trial, function(){});
      }
      else{
        if(tutover){

        }
      }
    }
    var instructions = {
      type: "html-button-response",
      stimulus: "<p>You are a frog hopping across some lilypads! " +
      "Unfortunately for you, you are so hungry for flies you forgot where the lilypads are. " +
      "</div>",
      choices: ["Start"],
      button_html: '<button class="jspsych-btn">%choice%</button>'
    };
    //timeline.push(instructions);
    timeline.push(tut1);
    //timeline.push(trial);
    //begin
  jsPsych.init({
  timeline: timeline,
  display_element: 'game',
      on_trial_finish: function(){
        postMap();
      },
      on_finish: function(){
        jsPsych.data.displayData();
        }
});

  </script>

</html>